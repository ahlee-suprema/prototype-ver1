<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출퇴근 분석</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .heatmap-cell:hover { transform: scale(1.15); z-index: 10; }
        .heatmap-cell { transition: all 0.15s ease; }
    </style>
</head>
<body class="bg-slate-50 p-6">
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        // Heatmap Component
        const Heatmap = ({ data, title }) => {
            const max = Math.max(...data.flat());
            const getColor = (v) => {
                const i = v / max;
                if (i === 0) return 'bg-slate-100';
                if (i < 0.25) return 'bg-blue-100';
                if (i < 0.5) return 'bg-blue-300';
                if (i < 0.75) return 'bg-blue-500 text-white';
                return 'bg-blue-700 text-white';
            };
            const hours = Array.from({ length: 12 }, (_, i) => `${7 + i}시`);
            const days = ['월', '화', '수', '목', '금'];

            return (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 className="text-lg font-semibold text-slate-800 mb-4">{title}</h3>
                    <div className="overflow-x-auto">
                        <div className="flex mb-2">
                            <div className="w-10" />
                            {hours.map((h, i) => <div key={i} className="flex-1 text-center text-xs text-slate-500 min-w-[36px]">{h}</div>)}
                        </div>
                        {data.map((row, di) => (
                            <div key={di} className="flex items-center mb-1">
                                <div className="w-10 text-sm text-slate-600 font-medium">{days[di]}</div>
                                {row.map((v, hi) => (
                                    <div key={hi} className={`heatmap-cell flex-1 h-7 min-w-[36px] mx-0.5 rounded ${getColor(v)} flex items-center justify-center text-xs font-medium cursor-pointer`} title={`${days[di]} ${hours[hi]}: ${v}명`}>
                                        {v > 0 && v}
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                    <div className="flex items-center justify-center gap-2 mt-4 text-xs">
                        <span className="text-slate-500">적음</span>
                        {['bg-slate-100', 'bg-blue-100', 'bg-blue-300', 'bg-blue-500', 'bg-blue-700'].map((c, i) => <div key={i} className={`w-5 h-4 rounded ${c}`} />)}
                        <span className="text-slate-500">많음</span>
                    </div>
                </div>
            );
        };

        // Trend Chart
        const TrendChart = ({ data, labels, title }) => {
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            const points = data.map((v, i) => ({ x: (i / (data.length - 1)) * 100, y: 100 - ((v - min) / range) * 80 - 10 }));
            const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

            return (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 className="text-lg font-semibold text-slate-800 mb-4">{title}</h3>
                    <div className="relative h-40">
                        <svg viewBox="0 0 100 100" className="w-full h-full" preserveAspectRatio="none">
                            {[0, 25, 50, 75, 100].map(y => <line key={y} x1="0" y1={y} x2="100" y2={y} stroke="#e2e8f0" strokeWidth="0.3" />)}
                            <path d={`${pathD} L 100 100 L 0 100 Z`} fill="url(#grad)" opacity="0.3" />
                            <path d={pathD} fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" />
                            {points.map((p, i) => <circle key={i} cx={p.x} cy={p.y} r="2.5" fill="#3b82f6" />)}
                            <defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#3b82f6" /><stop offset="100%" stopColor="#3b82f6" stopOpacity="0" /></linearGradient></defs>
                        </svg>
                    </div>
                    <div className="flex justify-between text-xs text-slate-400 mt-2">{labels.map((l, i) => <span key={i}>{l}</span>)}</div>
                    <div className="grid grid-cols-3 gap-4 mt-4 pt-4 border-t border-slate-100 text-center">
                        <div><div className="text-lg font-bold text-slate-800">{Math.round(data.reduce((a, b) => a + b) / data.length)}%</div><div className="text-xs text-slate-500">평균</div></div>
                        <div><div className="text-lg font-bold text-green-600">{max}%</div><div className="text-xs text-slate-500">최고</div></div>
                        <div><div className="text-lg font-bold text-amber-600">{min}%</div><div className="text-xs text-slate-500">최저</div></div>
                    </div>
                </div>
            );
        };

        // Late Analysis
        const LateAnalysis = ({ data }) => (
            <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 className="text-lg font-semibold text-slate-800 mb-4">지각 분석</h3>
                <div className="space-y-4">
                    {data.map((item, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-semibold">{item.name[0]}</div>
                                <div>
                                    <div className="font-medium text-slate-800">{item.name}</div>
                                    <div className="text-xs text-slate-500">{item.dept}</div>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-lg font-bold text-red-600">{item.count}회</div>
                                <div className="text-xs text-slate-500">평균 {item.avgMinutes}분</div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // Department Comparison
        const DeptComparison = ({ data }) => {
            const max = Math.max(...data.map(d => d.rate));
            return (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h3 className="text-lg font-semibold text-slate-800 mb-4">부서별 출근율</h3>
                    <div className="space-y-3">
                        {data.map((dept, idx) => (
                            <div key={idx}>
                                <div className="flex justify-between text-sm mb-1">
                                    <span className="text-slate-600">{dept.name}</span>
                                    <span className={`font-medium ${dept.rate >= 95 ? 'text-green-600' : dept.rate >= 90 ? 'text-amber-600' : 'text-red-600'}`}>{dept.rate}%</span>
                                </div>
                                <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full transition-all ${dept.rate >= 95 ? 'bg-green-500' : dept.rate >= 90 ? 'bg-amber-500' : 'bg-red-500'}`} style={{ width: `${dept.rate}%` }} />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ReportAttendance = () => {
            const [period, setPeriod] = useState('week');

            const heatmapData = [
                [5, 18, 42, 55, 52, 48, 42, 38, 35, 32, 25, 12],
                [8, 22, 48, 58, 55, 50, 45, 40, 38, 35, 28, 15],
                [3, 15, 38, 50, 48, 45, 40, 35, 32, 30, 22, 10],
                [10, 25, 52, 62, 58, 52, 48, 42, 40, 38, 30, 18],
                [2, 12, 35, 45, 42, 40, 35, 30, 28, 25, 18, 8],
            ];

            const trendData = [92, 94, 91, 96, 95, 93, 94, 95, 97, 94, 93, 95];
            const trendLabels = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

            const lateData = [
                { name: '정수진', dept: '개발1팀', count: 5, avgMinutes: 15 },
                { name: '한미래', dept: '마케팅팀', count: 4, avgMinutes: 22 },
                { name: '윤서준', dept: '디자인팀', count: 3, avgMinutes: 8 },
            ];

            const deptData = [
                { name: '개발1팀', rate: 96 },
                { name: '개발2팀', rate: 94 },
                { name: '디자인팀', rate: 92 },
                { name: '마케팅팀', rate: 89 },
                { name: '영업팀', rate: 95 },
                { name: '인사팀', rate: 98 },
            ];

            const handleExport = () => {
                const ws = XLSX.utils.aoa_to_sheet([['부서', '출근율'], ...deptData.map(d => [d.name, d.rate + '%'])]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '출퇴근분석');
                XLSX.writeFile(wb, `출퇴근분석_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="max-w-7xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800">출퇴근 분석</h1>
                            <p className="text-slate-500 text-sm">출퇴근 패턴 및 지각 분석</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex bg-slate-100 rounded-xl p-1">
                                {['week', 'month', 'year'].map(p => (
                                    <button key={p} onClick={() => setPeriod(p)} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${period === p ? 'bg-white shadow-sm text-slate-800' : 'text-slate-600'}`}>
                                        {p === 'week' ? '주간' : p === 'month' ? '월간' : '연간'}
                                    </button>
                                ))}
                            </div>
                            <button onClick={handleExport} className="px-4 py-2 bg-green-600 text-white rounded-xl text-sm font-medium hover:bg-green-700">엑셀 다운로드</button>
                        </div>
                    </div>

                    {/* Heatmap */}
                    <div className="mb-6">
                        <Heatmap data={heatmapData} title="시간대별 출근 히트맵 (이번 주)" />
                    </div>

                    {/* Charts Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <TrendChart data={trendData} labels={trendLabels} title="월간 출근율 추이" />
                        <DeptComparison data={deptData} />
                    </div>

                    {/* Late Analysis */}
                    <LateAnalysis data={lateData} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ReportAttendance />);
    </script>
</body>
</html>
